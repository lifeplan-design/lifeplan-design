<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LIFEPLAN-DESIGN | 住宅ローン計算シミュレーター</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background: #f8f9fa; font-family: "Noto Sans JP", sans-serif; }
        .container { max-width: 900px; margin: 30px auto; padding: 20px; background: #fff;
            border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        h1 { color: #0D6EFD; font-size: 24px; font-weight: 700; }
        input, select { width: 100%; margin: 4px 0 10px; padding: 8px; font-size: 15px; }
        button { background:#0D6EFD;color:#fff;padding:12px;width:100%;font-size:18px;
            border:none;border-radius:8px;font-weight:700; }
        button:hover { opacity: .85; cursor: pointer; }
        .card { border:1px solid #ddd; border-radius:10px; padding:10px; }
        .card-title { font-size:18px; font-weight:600; }
        canvas { max-height: 350px; }
    </style>
</head>

<body>
    <div class="container">
        <h1>住宅ローン返済シミュレーター</h1>
        <p>毎月返済額・総返済額・繰上返済による効果を可視化</p>

        <label>借入額（万円）</label>
        <input id="amount" value="3000" />

        <label>返済期間（年）</label>
        <input id="years" value="35" />

        <label>金利（％）</label>
        <input class="rate-input" value="1.0" />

        <hr />

        <label>繰上返済額（円）</label>
        <input id="prepayAmount" value="1000000" />

        <label>繰上返済タイミング（月数）</label>
        <input id="prepayMonth" value="60" />

        <label>繰上返済方式</label>
        <select id="prepayMode">
            <option value="reduce">返済額軽減型（Reduce）</option>
        </select>

        <button onclick="simulatePrepay()">計算する</button>

        <div id="prepayResult"></div>
        <canvas id="balanceChart" class="mt-4"></canvas>
    </div>

<script>
function unformatNumber(value) {
    return Number(String(value).replace(/,/g, "").replace(/[^\d.-]/g, ""));
}

/*----------------------------------
  Version 2.1 安定版
----------------------------------*/
function simulatePrepay() {

    const amount = unformatNumber(document.getElementById("amount").value) * 10000;
    const years = Number(document.getElementById("years").value);
    const mainRate = Number(document.querySelector(".rate-input").value.replace(/,/g, "")) / 100;

    const prepayAmount = unformatNumber(document.getElementById("prepayAmount").value);
    const prepayMonth = Number(document.getElementById("prepayMonth").value);
    const mode = document.getElementById("prepayMode").value;

    const monthlyRate = mainRate / 12;
    const n = years * 12;

    const monthlyPayment =
        amount * (monthlyRate * Math.pow(1 + monthlyRate, n)) /
        (Math.pow(1 + monthlyRate, n) - 1);

    /* Before */
    let beforeBalanceList = [];
    let tempBalance = amount;
    for (let i = 0; i < n; i++) {
        const interest = tempBalance * monthlyRate;
        const principal = monthlyPayment - interest;
        tempBalance -= principal;
        beforeBalanceList.push(Math.max(tempBalance, 0));
    }

    /* prepayMonth まで通常返済 */
    let balance = amount;
    let totalInterestBefore = 0;

    for (let i = 0; i < prepayMonth; i++) {
        const interest = balance * monthlyRate;
        balance -= (monthlyPayment - interest);
        totalInterestBefore += interest;
    }

    balance -= prepayAmount;
    if (balance < 0) balance = 0;

    /* afterBalanceList 準備 */
    let afterBalanceList = [];
    let totalInterestAfter = 0;

    // ★前半はBeforeをそのまま引き継ぐ
    for (let i = 0; i < prepayMonth; i++) {
        afterBalanceList.push(beforeBalanceList[i]);
    }

    /* Reduce */
    if (mode === "reduce") {

        const remainingMonths = n - prepayMonth;
        const newMonthlyPayment =
            balance * (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) /
            (Math.pow(1 + monthlyRate, remainingMonths) - 1);

        let tempBalance2 = balance;

        for (let i = 0; i < remainingMonths; i++) {
            const interestPayment = tempBalance2 * monthlyRate;
            const principalPayment = newMonthlyPayment - interestPayment;
            tempBalance2 -= principalPayment;
            totalInterestAfter += interestPayment;
            afterBalanceList.push(Math.max(tempBalance2, 0));
        }

        const totalInterestBeforeAll = monthlyPayment * n - amount;
        const totalInterest = totalInterestBefore + totalInterestAfter;
        const interestSaved = totalInterestBeforeAll - totalInterest;

        document.getElementById("prepayResult").innerHTML = `
            <div class="card mt-4">
                <div class="card-body">
                    <h2 class="card-title">繰上返済（返済額軽減型）</h2>
                    <p><strong>${Math.round(monthlyPayment).toLocaleString()} 円 → ${Math.round(newMonthlyPayment).toLocaleString()} 円</strong>
                    <br>▲ ${(monthlyPayment - newMonthlyPayment).toLocaleString()} 円/月</p>

                    <p><strong>${Math.round(totalInterestBeforeAll).toLocaleString()} 円 → ${Math.round(totalInterest).toLocaleString()} 円</strong>
                    <br>▲ ${Math.round(interestSaved).toLocaleString()} 円節約</p>

                    <p>返済期間：変わらず（${years} 年）</p>
                </div>
            </div>
        `;
    }

    /* グラフ描画 */
    if (window.balanceChartInstance) { window.balanceChartInstance.destroy(); }

    const ctx = document.getElementById("balanceChart");
    const labels = Array.from({ length: Math.max(beforeBalanceList.length, afterBalanceList.length) }, (_, i) => i + 1);

    window.balanceChartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [
                { label: "通常返済（Before）",
                    data: beforeBalanceList,
                    borderColor: "#0D6EFD",
                    backgroundColor: "rgba(13,110,253,0.08)",
                    borderWidth: 2 },
                { label: "返済額軽減型（Reduce）",
                    data: afterBalanceList,
                    borderColor: "#2ECC71",
                    backgroundColor: "rgba(46,204,113,0.15)",
                    borderWidth: 3 }
            ]
        },
        options: { responsive: true }
    });
}
</script>

</body>
</html>
